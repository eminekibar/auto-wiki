name: AI Code Reviewer ðŸ¤–

# 1. TETÄ°KLEYÄ°CÄ°: PR aÃ§Ä±ldÄ±ÄŸÄ±nda veya PR'a yeni kod eklendiÄŸinde Ã§alÄ±ÅŸÄ±r (KapatÄ±ldÄ±ÄŸÄ±nda DEÄžÄ°L!)
on:
  pull_request:
    types: [opened, synchronize]

env:
  OLLAMA_MODELS: /home/runner/.ollama/models
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub CLI (gh) aracÄ±nÄ±n yetkisi

jobs:
  code-review:
    runs-on: ubuntu-latest
    
    permissions:
      pull-requests: write # Robotun PR'a yorum yazabilmesi iÃ§in ÅžART!
      contents: read       # Kodu okuyabilmesi iÃ§in

    steps:
      - name: ðŸ“¥ Kodu Ä°ndir
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # SADECE SON HALÄ°NÄ° DEÄžÄ°L, GEÃ‡MÄ°ÅžÄ° DE Ä°NDÄ°R (FarklarÄ± bulabilmek iÃ§in)

      - name: ðŸ“¦ Yapay Zeka Modelini Ã–nbelleÄŸe Al (Cache)
        uses: actions/cache@v3
        with:
          path: /home/runner/.ollama/models
          key: ollama-llama3.2-1b-${{ runner.os }}

      - name: ðŸ¤– Ollama'yÄ± Kur ve BaÅŸlat
        run: |
          curl -fsSL https://ollama.com/install.sh | sh
          ollama serve &
          sleep 5
          ollama pull llama3.2:1b

      - name: ðŸ” DeÄŸiÅŸen KodlarÄ± (Git Diff) Ã‡Ä±kar
        run: |
          # GitHub CLI kullanarak sadece bu PR'da deÄŸiÅŸen satÄ±rlarÄ± alÄ±p bir dosyaya yazÄ±yoruz
          gh pr diff ${{ github.event.pull_request.number }} > diff.txt
          echo "DeÄŸiÅŸen kodlar baÅŸarÄ±yla Ã§Ä±karÄ±ldÄ±!"

      - name: ðŸ§  AI'a Kodu Ä°ncelet (Code Review)
        run: |
          # DeÄŸiÅŸen kodlarÄ± okuyoruz
          DIFF_CONTENT=$(cat diff.txt)
          
          # LLM'e vereceÄŸimiz sÄ±kÄ± talimat (Prompt Engineering)
          PROMPT="Sen kÄ±demli bir yazÄ±lÄ±m mÃ¼hendisisin ve Code Review yapÄ±yorsun. AÅŸaÄŸÄ±daki Git Diff (deÄŸiÅŸen kodlar) Ã§Ä±ktÄ±sÄ±nÄ± incele. Sadece deÄŸiÅŸen satÄ±rlara (baÅŸÄ±nda + veya - olan) odaklan. Kodda bir hata, mantÄ±k hatasÄ± veya iyileÅŸtirme fÄ±rsatÄ± gÃ¶rÃ¼yorsan TÃ¼rkÃ§e olarak kÄ±sa, profesyonel ve yapÄ±cÄ± bir eleÅŸtiri yaz. EÄŸer her ÅŸey mÃ¼kemmelse 'Kod harika gÃ¶rÃ¼nÃ¼yor, eline saÄŸlÄ±k.' de. Ä°ÅŸte kod:
          
          $DIFF_CONTENT"
          
          # Yapay zekadan cevabÄ± alÄ±yoruz ve bir metin dosyasÄ±na kaydediyoruz
          ollama run llama3.2:1b "$PROMPT" > ai_review.txt

      - name: ðŸ’¬ Sonucu PR'a Yorum Olarak At
        run: |
          # GitHub CLI ile AI'Ä±n yazdÄ±ÄŸÄ± metni PR'a yorum olarak gÃ¶nderiyoruz!
          gh pr comment ${{ github.event.pull_request.number }} --body-file ai_review.txt